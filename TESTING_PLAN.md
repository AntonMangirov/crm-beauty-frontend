# План тестирования бронирования и reCAPTCHA

## 1. Тестирование бронирования

### 1.1 Успешная запись (201)

**Шаги:**
1. Откройте страницу мастера: `http://localhost:5173/anna-krasotkina`
2. Нажмите "Записаться"
3. Выберите услугу (шаг 1)
4. Выберите дату (не ранее завтра, рабочий день, пн-пт)
5. Выберите доступное время (9:00-18:00 UTC)
6. Заполните форму:
   - Имя: `Иван Иванов`
   - Телефон: `+79991234567`
   - Комментарий: `Тестовая запись` (опционально)
7. Нажмите "Записаться"

**Ожидаемый результат:**
- ✅ Статус 201 (Created)
- ✅ Уведомление "Запись успешно создана!"
- ✅ Редирект на `/booking-success`
- ✅ В логах бэкенда: `logs/booking.log` - запись о создании
- ✅ В базе данных появилась новая запись в таблице `Appointment`

**Проверка в базе:**
```sql
SELECT * FROM "Appointment" ORDER BY "createdAt" DESC LIMIT 1;
```

---

### 1.2 Ошибка даты (400)

#### Тест 1: Дата в прошлом

**Шаги:**
1. Пройдите шаги 1-2 (выбор услуги и даты)
2. В консоли браузера выполните:
   ```javascript
   // Установите дату в прошлом
   const datePicker = document.querySelector('[data-testid="date-picker"]');
   // Или через DevTools измените значение DatePicker
   ```
3. Или используйте Postman с датой в прошлом:
   ```json
   {
     "name": "Тест",
     "phone": "+79991234567",
     "serviceId": "...",
     "startAt": "2020-01-01T10:00:00.000Z",
     "recaptchaToken": "test"
   }
   ```

**Ожидаемый результат:**
- ✅ Статус 400 (Bad Request)
- ✅ Сообщение: "Дата записи не может быть в прошлом" или "Дата записи должна быть минимум через 2 часа"
- ✅ Ошибка отображается в UI (snackbar)
- ✅ В логах: `logs/error.log` - запись об ошибке

#### Тест 2: Выходной день (суббота/воскресенье)

**Шаги:**
1. Выберите дату на субботу или воскресенье
2. Выберите время
3. Заполните форму и отправьте

**Ожидаемый результат:**
- ✅ Статус 400
- ✅ Сообщение: "Запись возможна только в рабочие дни (понедельник - пятница)"
- ✅ Ошибка в UI

#### Тест 3: Вне рабочих часов

**Шаги:**
1. Выберите рабочий день
2. Выберите время до 9:00 или после 18:00 UTC
3. Отправьте форму

**Ожидаемый результат:**
- ✅ Статус 400
- ✅ Сообщение: "Время записи должно быть в рабочих часах (9:00 - 18:00 UTC)"
- ✅ Ошибка в UI

#### Тест 4: Менее 2 часов до записи

**Шаги:**
1. Выберите дату = завтра
2. Выберите время, которое наступит менее чем через 2 часа
3. Отправьте форму

**Ожидаемый результат:**
- ✅ Статус 400
- ✅ Сообщение: "Дата записи должна быть минимум через 2 часа"
- ✅ Ошибка в UI

---

### 1.3 Слот занят (409)

**Шаги:**
1. Создайте первую запись (см. 1.1)
2. Не меняя дату и время, создайте вторую запись с другим именем/телефоном
3. Отправьте форму

**Ожидаемый результат:**
- ✅ Статус 409 (Conflict)
- ✅ Сообщение: "Выбранное время уже занято. Пожалуйста, выберите другое время"
- ✅ Ошибка в UI (snackbar)
- ✅ В логах: `logs/error.log` - запись о конфликте с деталями:
  ```
  [ERROR] Конфликт времени обнаружен
  Context: {
    requestedStart: "...",
    requestedEnd: "...",
    conflictingStart: "...",
    conflictingEnd: "..."
  }
  ```

**Альтернативный способ (Postman):**
1. Создайте запись через Postman
2. Сразу же создайте вторую с теми же датой/временем
3. Проверьте ответ 409

---

## 2. Тестирование reCAPTCHA

### 2.1 Проверка загрузки скрипта

**Шаги:**
1. Откройте DevTools (F12)
2. Перейдите на вкладку Network
3. Откройте страницу бронирования
4. Проверьте загрузку скрипта reCAPTCHA

**Ожидаемый результат:**
- ✅ Запрос к `https://www.google.com/recaptcha/api.js?render=...` выполнен
- ✅ В консоли нет ошибок загрузки

**Проверка в консоли:**
```javascript
// Проверка наличия grecaptcha
console.log(window.grecaptcha); // Должен быть объект
```

---

### 2.2 Проверка получения токена

**Шаги:**
1. Откройте консоль браузера (F12)
2. Выполните:
   ```javascript
   // Импортируйте функцию (если доступна) или используйте напрямую
   window.grecaptcha.ready(() => {
     window.grecaptcha.execute('YOUR_SITE_KEY', { action: 'booking' })
       .then(token => {
         console.log('Токен получен:', token);
         console.log('Длина токена:', token.length);
       });
   });
   ```

**Ожидаемый результат:**
- ✅ Токен получен (строка длиной ~1000+ символов)
- ✅ В консоли нет ошибок
- ✅ Токен начинается с символов (обычно буквы/цифры)

---

### 2.3 Проверка отправки токена на бэкенд

**Шаги:**
1. Откройте DevTools → Network
2. Создайте запись (см. 1.1)
3. Найдите запрос `POST /api/public/:slug/book`
4. Откройте вкладку Payload/Request

**Ожидаемый результат:**
- ✅ В теле запроса есть поле `recaptchaToken`
- ✅ Значение токена - длинная строка
- ✅ Токен отправлен вместе с другими данными

**Проверка в консоли:**
```javascript
// В интерцепторе axios (src/api/index.ts) должен логироваться токен
// Проверьте консоль на наличие логов [API]
```

---

### 2.4 Проверка валидации токена на бэкенде

**Шаги:**
1. Создайте запись с валидным токеном
2. Проверьте логи бэкенда: `logs/booking.log`

**Ожидаемый результат:**
- ✅ В логах: `[BOOKING] reCAPTCHA проверка пройдена`
- ✅ Запись создана успешно

**Тест с невалидным токеном:**
1. Используйте Postman
2. Отправьте запрос с `recaptchaToken: "invalid-token"`
3. Проверьте ответ

**Ожидаемый результат:**
- ✅ Статус 400
- ✅ Сообщение: "Проверка на бота не пройдена"
- ✅ В логах: `[WARN] reCAPTCHA проверка не пройдена`

---

### 2.5 Проверка без токена (dev режим)

**Шаги:**
1. Убедитесь, что `VITE_RECAPTCHA_SITE_KEY` не установлен в `.env`
2. Или установите тестовый ключ: `VITE_RECAPTCHA_SITE_KEY=test`
3. Создайте запись

**Ожидаемый результат (если бэкенд настроен пропускать в dev):**
- ✅ В консоли: `[reCAPTCHA] Site key не установлен, пропускаем проверку (dev режим)`
- ✅ Запись создана (если бэкенд пропускает проверку)

**Проверка:**
- В `src/utils/recaptcha.ts` функция `getRecaptchaToken` вернёт `null`
- В `BookingWizard` токен будет `undefined`
- Бэкенд должен обработать отсутствие токена (см. `src/utils/recaptcha.ts` на бэкенде)

---

### 2.6 Проверка в production режиме

**Шаги:**
1. Установите реальный Site Key в `.env`:
   ```
   VITE_RECAPTCHA_SITE_KEY=6Lc...ваш_ключ...
   ```
2. Соберите проект: `npm run build`
3. Запустите preview: `npm run preview`
4. Создайте запись

**Ожидаемый результат:**
- ✅ Токен получен и отправлен
- ✅ Бэкенд проверяет токен через Google API
- ✅ Запись создана только при успешной проверке

---

## 3. Проверка логов

### 3.1 Логи бронирования

**Файл:** `crm-beauty-backend/logs/booking.log`

**Проверьте наличие записей:**
- Начало обработки записи
- Поиск мастера
- Проверка reCAPTCHA
- Поиск/создание клиента
- Проверка конфликтов времени
- Создание записи
- Добавление уведомления

### 3.2 Логи ошибок

**Файл:** `crm-beauty-backend/logs/error.log`

**Проверьте записи для:**
- Ошибок валидации (400)
- Конфликтов времени (409)
- Ошибок reCAPTCHA
- Других ошибок

---

## 4. Быстрая проверка через Postman

Используйте коллекцию `postman_collection.json`:

1. **Valid Booking** - успешная запись
2. **Invalid Date Format** - ошибка 400
3. **Time Slot Conflict** - ошибка 409
4. **Missing reCAPTCHA Token** - ошибка валидации

---

## 5. Чек-лист

- [ ] Успешная запись создаётся (201)
- [ ] Ошибка даты в прошлом (400)
- [ ] Ошибка выходного дня (400)
- [ ] Ошибка вне рабочих часов (400)
- [ ] Ошибка менее 2 часов до записи (400)
- [ ] Конфликт времени (409)
- [ ] reCAPTCHA скрипт загружается
- [ ] reCAPTCHA токен получается
- [ ] reCAPTCHA токен отправляется на бэкенд
- [ ] Бэкенд проверяет токен
- [ ] Логи записываются в файлы
- [ ] Ошибки отображаются пользователю

---

## Примечания

- В dev режиме reCAPTCHA может быть пропущена, если ключ не установлен
- Все даты/время в UTC на бэкенде
- Минимальное время записи: 2 часа от текущего момента
- Максимальное время записи: 30 дней от текущего момента
- Рабочие часы: 9:00-18:00 UTC
- Рабочие дни: понедельник - пятница

